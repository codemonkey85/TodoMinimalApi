@page "/"
@using System.Collections.ObjectModel
@using Todo.Shared.Entities.DTO.Todo
@inject IHttpClientFactory ClientFactory
@inject IDialogService DialogService
@inject ILogger<Home> Logger
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>@App.SetPageTitle("List Todos")</PageTitle>

@if (todos is null)
{
    <MudText Typo="Typo.body1">Loading, please wait...</MudText>
}
else
{
    <MudDataGrid Items="@_items" T="TodoItemDTO"
    EditMode="DataGridEditMode.Form" CommittedItemChanges="@CommittedItemChanges"
    Dense="true" Bordered="false"
    ReadOnly="false" EditTrigger="DataGridEditTrigger.Manual">
        <ToolBarContent>
            <MudText Typo="Typo.h3">Todos</MudText>
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.Add" Variant="Variant.Filled" 
            Color="Color.Primary"/>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="p => p.Name" Title="Name">
                <CellTemplate>
                    <MudStack Row>
                        @if(!context.Item.IsComplete)
                        {
                            <MudText Style="text-decoration: line-through;" Typo="Typo.body1">@context.Item.Name</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body1">@context.Item.Name</MudText>
                        }
                    </MudStack>
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="p => p.IsComplete" Title="Status" Hidden="true">
                <EditTemplate>
                    <MudSwitch @bind-Value="context.Item.IsComplete"
                    Label="Complete?" LabelPlacement="Placement.Start"
                    Color="Color.Primary"/>
                </EditTemplate>
            </PropertyColumn>
            <TemplateColumn CellClass="d-flex justify-end">
                <CellTemplate>
                    <MudStack Row>
                        <MudIconButton OnClick="@context.Actions.StartEditingItemAsync"
                        Icon="@Icons.Material.Filled.Edit" Size="@Size.Small" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="@Size.Small"
                        Color="Color.Error" OnClick="@(async() => await DeleteItemAsync(context.Item))"/>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
}

@code {
    private ListTodos? todos;
    private ObservableCollection<TodoItemDTO> _items = [];

    protected override async Task OnInitializedAsync()
    {
        using var client = ClientFactory.CreateClient("Todo.Api");
        todos = await client.GetFromJsonAsync<ListTodos>("/api/todos");
        _items = new(todos!.Todos);
    }

    async Task DeleteItemAsync(TodoItemDTO item)
    {
        var parameters = new DialogParameters<_DataGridDeleteDialog> { { x => x.Todo, item } };

        var dialog = await DialogService.ShowAsync<_DataGridDeleteDialog>("Delete Todo", parameters);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            _items.Remove(item);
        }
    }

    async Task CommittedItemChanges(TodoItemDTO item)
    {
        Logger.LogInformation($"Event = CommittedItemChanges, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");
        using var client = ClientFactory.CreateClient("Todo.Api");
        var result = await client.PutAsJsonAsync<TodoItemDTO>($"/api/todos/{item.Id}", item);
        if (result.IsSuccessStatusCode)
        {
            Snackbar.Add("Updated Item.", Severity.Success);
            _items.ReplaceItem(r => r.Id == item.Id, item);
        }
        else
        {
            Snackbar.Add("Error updating item.", Severity.Error);
        }
    }
}